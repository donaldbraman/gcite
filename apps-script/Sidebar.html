<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 15px;
      background: #f8f9fa;
    }
    .search-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .result-card {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin: 10px 0;
      transition: box-shadow 0.2s;
    }
    .result-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .relevance-bar {
      height: 4px;
      background: linear-gradient(to right, #28a745, #ffc107);
      border-radius: 2px;
      margin: 8px 0;
    }
    .citation-text {
      font-size: 0.9em;
      color: #495057;
      line-height: 1.6;
      font-style: italic;
    }
    .source-info {
      font-size: 0.85em;
      color: #6c757d;
      margin-top: 10px;
    }
    .copy-btn {
      font-size: 0.85em;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .stats {
      font-size: 0.85em;
      color: #6c757d;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="search-container">
    <h5>üîç gCite Search</h5>

    <div class="mb-3">
      <label class="form-label">Query</label>
      <textarea id="query" class="form-control" rows="3"
                placeholder="Enter search query or click 'Use Selection'"></textarea>
    </div>

    <div class="d-flex gap-2">
      <button onclick="useSelection()" class="btn btn-outline-primary btn-sm">
        Use Selection
      </button>
      <button onclick="search()" class="btn btn-primary btn-sm">
        Search
      </button>
    </div>
  </div>

  <div id="results" class="mt-3"></div>

  <script>
    let currentResults = null;

    function useSelection() {
      google.script.run
        .withSuccessHandler(function(text) {
          if (text) {
            document.getElementById('query').value = text;
          } else {
            showMessage('No text selected', 'warning');
          }
        })
        .withFailureHandler(function(err) {
          showError('Failed to get selection: ' + err);
        })
        .getSelectedText();
    }

    function search() {
      const query = document.getElementById('query').value.trim();
      if (!query) {
        showMessage('Please enter a query', 'warning');
        return;
      }

      showLoading();

      google.script.run
        .withSuccessHandler(displayResults)
        .withFailureHandler(showError)
        .searchCitations({
          query: query,
          max_results: 10,
          filter: false  // No AI filtering in Phase 1
        });
    }

    function showLoading() {
      document.getElementById('results').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p class="mt-3">Searching citations...</p>
        </div>
      `;
    }

    function displayResults(data) {
      if (data.error) {
        showError(data.error);
        return;
      }

      currentResults = data;

      let html = `
        <div class="alert alert-success">
          <strong>Found ${data.results_count} citations</strong>
          <div class="stats">${data.processing_time_ms}ms</div>
        </div>
      `;

      if (data.chunks && data.chunks.length > 0) {
        data.chunks.forEach(function(chunk, idx) {
          html += `
            <div class="result-card">
              <div class="d-flex justify-content-between align-items-start">
                <strong>[${idx + 1}] ${escapeHtml(chunk.source.title)}</strong>
                <span class="badge bg-primary">${chunk.relevance_score.toFixed(2)}</span>
              </div>

              <div class="relevance-bar" style="width: ${chunk.relevance_score * 100}%"></div>

              <div class="citation-text">
                "${escapeHtml(chunk.text)}"
              </div>

              <div class="source-info">
                ${escapeHtml(chunk.source.citation)}
              </div>

              <button onclick="copyChunk(${idx})" class="btn btn-sm btn-outline-secondary copy-btn mt-2">
                Copy
              </button>
            </div>
          `;
        });

        html += `
          <button onclick="copyAll()" class="btn btn-primary w-100 mt-3">
            Copy All to Clipboard
          </button>
        `;
      } else {
        html += `
          <div class="alert alert-warning">
            No relevant citations found. Try refining your query.
          </div>
        `;
      }

      document.getElementById('results').innerHTML = html;
    }

    function showError(error) {
      document.getElementById('results').innerHTML = `
        <div class="alert alert-danger">
          <strong>Error:</strong> ${escapeHtml(error.toString())}
        </div>
      `;
    }

    function showMessage(message, type) {
      document.getElementById('results').innerHTML = `
        <div class="alert alert-${type}">
          ${escapeHtml(message)}
        </div>
      `;
    }

    function copyChunk(index) {
      if (!currentResults || !currentResults.chunks[index]) {
        showMessage('Unable to copy chunk', 'danger');
        return;
      }

      const chunk = currentResults.chunks[index];
      const text = `"${chunk.text}"\n\n${chunk.source.citation}`;

      copyToClipboard(text);
      showMessage('Citation copied to clipboard!', 'success');
    }

    function copyAll() {
      if (!currentResults || !currentResults.formatted_output) {
        showMessage('No results to copy', 'danger');
        return;
      }

      copyToClipboard(currentResults.formatted_output);
      showMessage('All citations copied to clipboard!', 'success');
    }

    function copyToClipboard(text) {
      // Create temporary textarea
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();

      try {
        document.execCommand('copy');
      } catch (err) {
        console.error('Copy failed:', err);
      }

      document.body.removeChild(textarea);
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
